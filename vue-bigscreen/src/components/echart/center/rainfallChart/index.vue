<template>
  <div>
    <RainfallChartContent :cdata="chartData" />
  </div>
</template>

<script>
import RainfallChartContent from './chart.vue'
import { mapState } from 'vuex'
import axios from 'axios'
export default {
  name: 'RainfallChartContainer',
  components: {
    RainfallChartContent
  },
  data() {

    return {
      chartData: {
        timeData: [
          "2015-03",
          "2015-10",
          "2015-11",
          "2015-12",
          "2016-02",
          "2016-03",
          "2016-06",
          "2016-07",
          "2016-08",
          "2016-10",
          "2016-11",
          "2016-12",
          "2017-01",
          "2017-02",
          "2017-03",
          "2017-04",
          "2017-05",
          "2017-06",
          "2017-07",
          "2017-08",
          "2017-09",
          "2017-10",
          "2017-11",
          "2017-12",
          "2018-01",
          "2018-02",
          "2018-03",
          "2018-04",
          "2018-05",
          "2018-06",
          "2018-07",
          "2018-08",
          "2018-09",
          "2018-10",
          "2018-11",
          "2018-12",
          "2019-01",
          "2019-02",
          "2019-03",
          "2019-04",
          "2019-05",
          "2019-06",
          "2019-07",
          "2019-08",
          "2019-09",
          "2019-10",
          "2019-11",
          "2019-12",
          "2020-01",
          "2020-02",
          "2020-03",
          "2020-04",
          "2020-05",
          "2020-06",
          "2020-07",
          "2020-08",
          "2020-09",
          "2020-10",
          "2020-11",
          "2020-12",
          "2021-01",
          "2021-02",
          "2021-03",
          "2021-04",
          "2021-05",
          "2021-06",
          "2021-07",
          "2021-08",
          "2021-09",
          "2021-10",
          "2021-11",
          "2021-12",
          "2022-01",
          "2022-02",
          "2022-03",
          "2022-04",
          "2022-05",
          "2022-06",
          "2022-07",
          "2022-08",
          "2022-09",
          "2022-10",
          "2022-11",
          "2022-12",
          "2023-01",
          "2023-02",
          "2023-03",
          "2023-04",
          "2023-05",
          "2023-06",
          "2023-07",
          "2023-08",
          "2023-09",
          "2023-10",
          "2023-11",
          "2023-12",
          "2024-01",
          "2024-02",
          "2024-03",
          "2024-04",
          "2024-05",
          "2024-06",
          "2024-07",
          "2024-08",
          "2024-09",
          "2024-10"
        ],
        flowData: [
          2,
          1,
          3,
          5,
          3,
          2,
          3,
          3,
          6,
          5,
          5,
          1,
          5,
          3,
          5,
          2,
          10,
          3,
          5,
          11,
          15,
          16,
          7,
          15,
          25,
          14,
          19,
          13,
          15,
          15,
          18,
          14,
          19,
          20,
          21,
          16,
          13,
          32,
          16,
          16,
          25,
          34,
          23,
          14,
          16,
          29,
          25,
          12,
          26,
          21,
          33,
          35,
          31,
          50,
          43,
          39,
          37,
          36,
          40,
          40,
          43,
          33,
          65,
          37,
          43,
          34,
          54,
          46,
          58,
          54,
          43,
          80,
          69,
          74,
          91,
          48,
          46,
          31,
          45,
          42,
          54,
          54,
          43,
          45,
          65,
          32,
          67,
          68,
          52,
          43,
          50,
          37,
          108,
          85,
          74,
          65,
          71,
          133,
          58,
          49,
          49,
          65,
          54,
          79,
          92,
          74
        ],
        rainfallData: [
          1,
          1,
          1,
          1,
          2,
          1,
          4,
          2,
          2,
          1,
          3,
          1,
          3,
          2,
          1,
          1,
          2,
          3,
          7,
          7,
          3,
          3,
          3,
          4,
          7,
          9,
          4,
          2,
          13,
          7,
          5,
          7,
          7,
          6,
          9,
          3,
          2,
          5,
          3,
          4,
          8,
          7,
          7,
          5,
          11,
          12,
          13,
          9,
          11,
          3,
          14,
          12,
          11,
          10,
          9,
          10,
          15,
          20,
          20,
          32,
          40,
          18,
          17,
          11,
          13,
          19,
          41,
          50,
          20,
          25,
          17,
          29,
          25,
          14,
          33,
          20,
          28,
          17,
          11,
          18,
          16,
          14,
          16,
          20,
          19,
          21,
          14,
          18,
          8,
          5,
          2,
          12,
          11,
          12,
          11,
          13,
          14,
          22,
          9,
          18,
          4,
          24,
          21,
          8,
          15,
          6
        ]
      },
      d: this.$store.state
    };
  },
  mounted() {
  },
  computed: {
    ...mapState(['currentRepository'])
  },
  methods: {
    async fetchData(path) {
      const datePattern = /^\d{4}-(0[1-9]|1[0-2])$/;
      const filterData = (datas) => {
        let filteredDatas = {};
        for (const key in datas) {
          if (datePattern.test(key)) {
            filteredDatas[key] = datas[key];
          }
        }
        return filteredDatas;
      }

      let starResponse = await axios.get(path + '/stars.json');
      let starData = await starResponse.data;
      starData = filterData(starData);
      let forkResponse = await axios.get(path + '/technical_fork.json');
      let forkData = await forkResponse.data;
      forkData = filterData(forkData);
      let issueResponse = await axios.get(path + '/issues_new.json');
      let issueData = await issueResponse.data;
      issueData = filterData(issueData);

      // 获取所有的键
      let starKeys = Object.keys(starData);
      let forkKeys = Object.keys(forkData);
      let issueKeys = Object.keys(issueData);

      // 找出公共的键
      let commonKeys = starKeys.filter(value => forkKeys.includes(value) && issueKeys.includes(value));

      // 创建新的json对象
      let data = {
        timeData: commonKeys.map(key => key),
        flowData: commonKeys.map(key => starData[key]),
        rainfallData: commonKeys.map(key => forkData[key]),
      }
      return data
    }
  },
  watch: {
    currentRepository: {
      handler: async function (newVal) {
        this.chartData = await this.fetchData('https://oss.x-lab.info/open_digger/github/' + newVal);
      },
      deep: true
    }
  }

}
</script>